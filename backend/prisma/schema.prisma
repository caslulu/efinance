generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Frequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

model User {
  id                    Int                   @id @default(autoincrement())
  username              String
  email                 String                @unique
  password              String?
  fullName              String?
  avatarUrl             String?
  birthDate             DateTime?
  resetToken            String?
  resetTokenExpiry      DateTime?
  twoFactorToken        String?
  twoFactorTokenExpiry  DateTime?
  isTwoFactorEnabled    Boolean               @default(false)
  isEmailVerified       Boolean               @default(false)
  emailVerificationToken String?
  emailVerificationTokenExpiry DateTime?
  wallets               Wallet[]
  wishlists             Wishlist[]
  transactionCategories TransactionCategory[]
  subscriptions         Subscription[]
  budgets               Budget[]
  priceAlertNotifications WishlistPriceAlertNotification[]
}

model Wallet {
  id           Int           @id @default(autoincrement())
  user_id      Int
  user         User          @relation(fields: [user_id], references: [id])
  actual_cash  Decimal       @db.Decimal(10, 2)
  name         String
  type         String
  closing_day  Int?
  due_day      Int?
  order        Int           @default(0)
  transactions Transaction[]
  investments  Investment[]
  subscriptions Subscription[]
}

model Transaction {
  id                  Int                 @id @default(autoincrement())
  transaction_date    DateTime
  wallet_id           Int
  wallet              Wallet              @relation(fields: [wallet_id], references: [id])
  transaction_type    String
  payment_method      String?
  description         String?
  is_recurring        Boolean
  value               Decimal             @db.Decimal(10, 2)
  installment_id      String?
  installment_total   Int?
  installment_number  Int?
  category_id         Int
  TransactionCategory TransactionCategory @relation(fields: [category_id], references: [id])
  subscription_id     Int?
  subscription        Subscription?       @relation("SubscriptionTransactions", fields: [subscription_id], references: [id])
}

model Subscription {
  id                Int                @id @default(autoincrement())
  user_id           Int
  user              User               @relation(fields: [user_id], references: [id])
  wallet_id         Int
  wallet            Wallet             @relation(fields: [wallet_id], references: [id])
  category_id       Int
  category          TransactionCategory @relation(fields: [category_id], references: [id])
  
  name              String
  description       String?
  value             Decimal            @db.Decimal(10, 2)
  transaction_type  String             @default("EXPENSE")
  frequency         Frequency
  status            SubscriptionStatus @default(ACTIVE)
  start_date        DateTime
  next_billing_date DateTime
  payment_method    String?
  
  transactions      Transaction[]      @relation("SubscriptionTransactions")
}

model TransactionCategory {
  id           Int           @id @default(autoincrement())
  user         User          @relation(fields: [user_id], references: [id])
  user_id      Int
  name         String
  icon         String?
  transactions Transaction[]
  subscriptions Subscription[]
  budgets      Budget[]
}

model Budget {
  id          Int                 @id @default(autoincrement())
  user_id     Int
  user        User                @relation(fields: [user_id], references: [id])
  category_id Int
  category    TransactionCategory @relation(fields: [category_id], references: [id])
  limit       Decimal             @db.Decimal(10, 2)
  
  @@unique([user_id, category_id])
}

model Investment {
  start_date              DateTime
  maturity_date           DateTime?
  id                      Int                @id @default(autoincrement())
  wallet_id               Int
  wallet                  Wallet             @relation(fields: [wallet_id], references: [id])
  investment_category     Int
  typeInvestment          TypeInvestment     @relation(fields: [investment_category], references: [investment_category])
  investment_amount       Decimal            @db.Decimal(10, 2)
  current_amount          Decimal            @db.Decimal(10, 2)
  name                    String
  indicator_id            Int?
  economicIndicator       EconomicIndicator? @relation(fields: [indicator_id], references: [id])
  percentage_of_indicator Decimal?           @db.Decimal(10, 2)
  fix_rate                Decimal?           @db.Decimal(10, 2)
}

model EconomicIndicator {
  id           Int          @id @default(autoincrement())
  name         String
  current_rate Decimal      @db.Decimal(10, 2)
  last_update  DateTime
  investments  Investment[]
}

model TypeInvestment {
  investment_category Int          @id @default(autoincrement())
  name                String
  investments         Investment[]
}

model Wishlist {
  id       Int               @id @default(autoincrement())
  user     User              @relation(fields: [user_id], references: [id])
  user_id  Int
  name     String
  products WishlistProduct[]
}

model WishlistProduct {
  id           Int      @id @default(autoincrement())
  id_wishlist  Int
  wishlist     Wishlist @relation(fields: [id_wishlist], references: [id])
  name_product String
  price        Decimal  @db.Decimal(10, 2)
  url          String?
  send_price_alerts Boolean @default(false)
  last_checked_price Decimal? @db.Decimal(10, 2)
  priceAlertNotifications WishlistPriceAlertNotification[]
  history      WishlistProductHistory[]
}

model WishlistProductHistory {
  id                  Int             @id @default(autoincrement())
  wishlist_product_id Int
  wishlistProduct     WishlistProduct @relation(fields: [wishlist_product_id], references: [id])
  price               Decimal         @db.Decimal(10, 2)
  created_at          DateTime        @default(now())

  @@index([wishlist_product_id])
}

model WishlistPriceAlertNotification {
  id                  Int             @id @default(autoincrement())
  user_id             Int
  user                User            @relation(fields: [user_id], references: [id])
  wishlist_product_id Int
  wishlistProduct     WishlistProduct @relation(fields: [wishlist_product_id], references: [id])
  old_price           Decimal         @db.Decimal(10, 2)
  new_price           Decimal         @db.Decimal(10, 2)
  message             String
  is_read             Boolean         @default(false)
  notified_at         DateTime        @default(now())

  @@index([user_id, is_read])
  @@index([wishlist_product_id])
}
